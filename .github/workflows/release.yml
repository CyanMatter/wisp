name: Build, Test, Deploy

on:
    push:
        branches:
        - 'main'

    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
    build:
        name: âš¡ Build
        runs-on: ubuntu-latest
        
        steps:
        - name: â¬ Checkout repo
          uses: actions/checkout@v3

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ—ƒï¸ Set up Rust Cache
          uses: actions/cache@v3
          with:
            path: |
                ~/.rustup/toolchains
                ~/.rustup/update-hashes
                ~/.rustup/settings.toml
            key: toolchain-${{ hashFiles('rust-toolchain') }}

        - name: ğŸ—ƒï¸ Set up Cargo cache
          uses: actions/cache@v3
          with:
            path: |
                ~/.cargo/bin/
                ~/.cargo/registry/index/
                ~/.cargo/registry/cache/
                ~/.cargo/git/db/
                target/            
            key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
            restore-keys: ${{ runner.os }}-cargo-

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ—ï¸ Set up Rust toolchain
          uses: actions-rs/toolchain@v1
          with:
            profile: minimal
            toolchain: stable

        - name: ğŸ¯ Add WASM target
          run: rustup target add wasm32-unknown-unknown

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ” Check Trunk installation
          id: trunk_installed
          uses: andstor/file-existence-action@v3
          with:
            files: "/home/runner/.cargo/bin/trunk*"
        
        - name: ğŸ—ï¸ Download and install Trunk binary
          if: steps.trunk_installed.outputs.files_exists == 'false'
          run: wget -qO- https://github.com/trunk-rs/trunk/releases/download/v0.18.8/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ—ï¸ Set up PNPM 7
          uses: pnpm/action-setup@v2.2.2
          with:
            version: 7.9.0
            run_install: false

        - name: ğŸ” Get PNPM store directory
          id: pnpm-cache
          run: |
            echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

        - name: ğŸ—ƒï¸ Set up PNPM cache
          uses: actions/cache@v3
          with:
            path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
            key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
            restore-keys: ${{ runner.os }}-pnpm-store-

        - name: ğŸ—ï¸ Install Node dependencies
          run: pnpm install --no-frozen-lockfile

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: âš¡ Build
          run: ./trunk build --release --public-url "${GITHUB_REPOSITORY#*/}"

        - name: ğŸ”© Minify
          run: ./node_modules/.bin/esbuild ./dist/**/*.js --bundle --minify --outdir=./dist --allow-overwrite

        - name: ğŸŒ Upload artifact
          uses: actions/upload-pages-artifact@v1
          with:
            path: ./dist

    # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    test:
        name: ğŸ”¬ Test
        needs: build
        runs-on: ubuntu-20.04

        steps:
        - name: â¬ Checkout repo
          uses: actions/checkout@v3
          with:
            ref: ${{ github.ref }}

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ” Check wasm-pack installation
          id: wasm_pack_installed
          uses: andstor/file-existence-action@v3
          with:
            files: "/home/runner/.cargo/bin/wasm-pack*"

        - name: ğŸ—ï¸ Download and install wasm-pack binary
          if: steps.wasm_pack_installed.outputs.files_exists == 'false'
          run: wget -qO- https://github.com/rustwasm/wasm-pack/releases/download/v0.12.1/wasm-pack-v0.12.1-x86_64-unknown-linux-musl.tar.gz | tar -xzf-

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        
        - name: ğŸ—ï¸ Set up and cache Firefox
          uses: browser-actions/setup-firefox@v1
          with:
            firefox-version: '123.0.1'

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ§ª Run tests
          run: ./wasm-pack test --headless --firefox

    # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    deploy:
        name: ğŸš€ Deploy
        needs: build
        runs-on: ubuntu-20.04
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: ğŸš€ Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v1
