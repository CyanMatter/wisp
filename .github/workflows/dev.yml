name: Build, Test

on:
    push:
        branches:
        - '**'
        - '!main'
    pull_request:
        branches:
        - '**'

    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
    build:
        name: âš¡ Build
        runs-on: ubuntu-latest
        
        steps:
        - name: â¬ Checkout repo
          uses: actions/checkout@v3

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ—ƒï¸ Set up Rust Cache
          uses: actions/cache@v3
          with:
            path: |
                ~/.rustup/toolchains
                ~/.rustup/update-hashes
                ~/.rustup/settings.toml
            key: toolchain-${{ hashFiles('rust-toolchain') }}

        - name: ğŸ—ƒï¸ Set up Cargo cache
          uses: actions/cache@v3
          with:
            path: |
                ~/.cargo/bin/
                ~/.cargo/registry/index/
                ~/.cargo/registry/cache/
                ~/.cargo/git/db/
                target/            
            key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
            restore-keys: ${{ runner.os }}-cargo-

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ—ï¸ Set up Rust toolchain
          uses: actions-rs/toolchain@v1
          with:
            profile: minimal
            toolchain: stable

        - name: ğŸ¯ Add WASM target
          run: rustup target add wasm32-unknown-unknown

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ” Check Trunk installation
          id: trunk_installed
          uses: andstor/file-existence-action@v3
          with:
            files: "/home/runner/.cargo/bin/trunk*"
        
        - name: ğŸ—ï¸ Download and install Trunk binary
          if: steps.trunk_installed.outputs.files_exists == 'false'
          run: wget -qO- https://github.com/trunk-rs/trunk/releases/download/v0.18.8/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf- -C /home/runner/.cargo/bin

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: âš¡ Build
          run: /home/runner/.cargo/bin/trunk build --release --public-url "${GITHUB_REPOSITORY#*/}"

    # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

    test:
        name: ğŸ”¬ Test
        needs: build
        runs-on: ubuntu-20.04

        steps:
        - name: â¬ Checkout repo
          uses: actions/checkout@v3
          with:
            ref: ${{ github.ref }}

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ” Check wasm-pack installation
          id: wasm_pack_installed
          uses: andstor/file-existence-action@v3
          with:
            files: "/home/runner/.cargo/bin/wasm-pack*"

        - name: ğŸ—ï¸ Download and install wasm-pack binary
          if: steps.wasm_pack_installed.outputs.files_exists == 'false'
          run: wget -qO- https://github.com/rustwasm/wasm-pack/releases/download/v0.12.1/wasm-pack-v0.12.1-x86_64-unknown-linux-musl.tar.gz | tar -xzf- -C /home/runner/.cargo/bin

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
        
        - name: ğŸ—ï¸ Set up and cache Firefox
          uses: browser-actions/setup-firefox@v1
          with:
            firefox-version: '123.0.1'

        # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

        - name: ğŸ§ª Run tests
          run: /home/runner/.cargo/bin/wasm-pack test --headless --firefox
